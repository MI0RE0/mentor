from django.shortcuts import render, redirect
from .models import Title, Questions
import json
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import random

def index(request):
    return render(request, 'index.html')
def main(request): 
    data = Title.objects.values('name')
    
    return render(request, 'main_base.html',{'data':data})




@csrf_exempt
def question_box(request):
    """
    クイズの質問を取得するAPIエンドポイント
    POSTリクエストのみ受け付け、ランダムな質問を返す
    """
    if request.method != "POST":
        return JsonResponse({'error': 'POSTメソッドのみ受け付けています'}, status=405)
        
    try:
        # リクエストボディの解析
        body = json.loads(request.body.decode('utf-8'))
        title_name = body.get('thistitle')
        count = body.get('count')
        total_counts = body.get('total_counts')
        
        # タイトル名のバリデーション
        if not title_name:
            return JsonResponse({'error': 'タイトル名が指定されていません'}, status=400)
            
        # セッションの初期化（使用済みID管理用）
        if 'used_id' not in request.session:
            request.session['used_id'] = []
            
        # 未使用の問題IDを取得
        id_list = list(Questions.objects.filter(title__name=title_name).values_list('id', flat=True))
        if not id_list:
            return JsonResponse({'error': 'このタイトルに問題が登録されていません'}, status=404)
            
        max_num = max(id_list)
        all_id = set(range(1, max_num + 1))
        used_id = set(request.session['used_id'])
        available_id = all_id - used_id
        
        # 全問題を使い切った場合
        if not available_id:
            request.session['used_id'] = []
            return JsonResponse({'end': 'end'})
            
        # 問題数制限チェック
        if count > total_counts:
            return JsonResponse({'end': 'end'})
            
        # ランダムな問題を選択
        num = random.choice(list(available_id))
        request.session['used_id'].append(num)
        request.session.modified = True
        
        # 問題データの取得
        questions = Questions.objects.select_related('title').filter(
            title__name=title_name, 
            id=num
        ).values('questions', 'answers', 'descriptions', 'images_path').first()
        
        # レスポンスの作成
        return JsonResponse({
            'name': title_name,
            'questions': questions['questions'],
            'answers': questions['answers'],
            'descriptions': questions['descriptions'],
            'images_path': questions['images_path']
        })
            
    except json.JSONDecodeError:
        return JsonResponse({'error': 'リクエストデータの形式が不正です'}, status=400)
    except Exception as e:
        return JsonResponse({'error': f'処理中にエラーが発生しました: {str(e)}'}, status=500)

def save_data(request):
    title_name = '本免許問題集'
























    # 質問リスト（番号, 質問文, 回答（"o" or "x"））
    
    question_list = [
    ["原動機付自転車の積載装置に積むことのできる積載物の幅は、積載装置の幅に左右それぞれ0.3mを加えた幅までである。", "x", "本文の通り", ""],
    ["交通事故を起こした時、後続事故の恐れがある場合でも負傷者が頭部に傷を受けている時は医師や救急車が到着するまでの間、負傷者を移動してはならない。", "x", "本文の通り", ""],
    ["この標識や信号のある交差点の通行方法は同じである。", "o", "本文の通り", "/static/quest_pics/4-103.png"],
    ["人の乗り降りや5分以内の荷物の積みおろしのための停止は、駐車にならない。", "o", "本文の通り", ""],
    ["エンジンブレーキは、低速ギアになるほど制動力は小さくなる。", "x", "本文の通り", ""],
    ["二輪車の乗車姿勢は、手首を下げてハンドルを手前に引くような気持ちで、グリップを軽く持ち、肩の力を抜き、ひじをわずかに曲げ、背筋を伸ばして視線を先に向けるのがよい。", "x", "本文の通り", ""],
    ["このマークの付いている自動車を高齢者が運転している場合には、危険を避けるためやむを得ない場合の他は、その車の側方に幅寄せをしたり、無理に割り込んではならない。", "o", "本文の通り", "/static/quest_pics/4-107.png"],
    ["同一方向に進行しながら進路を変える時の合図の時期は、進路を変えようとする時の30m手前の時期である。", "x", "本文の通り", ""],
    ["運転者が疲れている時は、危険を認知し判断するのに時間がかかるので、空走距離は長くなる。", "o", "本文の通り", ""],
    ["この標示がある道路では、必ず中央線から右側部分にはみ出して通行しなければならない。", "x", "本文の通り", "/static/quest_pics/4-110.png"],
    ["走行中にタイヤがパンクした時は、ハンドルをしっかりにぎり車の方向を直すことに全力を傾け、断続的にブレーキをかけるのがよい。", "o", "本文の通り", ""],
    ["白や黄のつえを持った人やその通行に支障のある高齢者が通行している場合には、あらかじめその手前で減速し、これらの人との間に安全な間隔をあけて通行しなければならない。", "x", "本文の通り", ""],
    ["交差点や交差点付近以外の所で、緊急自動車が近づいてきた時は、道路の左側に寄って進路を譲らなければならない。", "o", "本文の通り", ""],
    ["自動車は登録(届出)を受けて、番号標（ナンバープレート）をつけなければ運転することはできない。", "o", "本文の通り", ""],
    ["夜間、見通しの悪い交差点やカーブなどの手前では、前照灯を上向きに切り替えるなどするとよい。", "o", "本文の通り", ""],
    ["この信号に対面する原動機付自転車は、一時停止をすれば直進することはできるが、右左折することはできない。", "x", "本文の通り", "/static/quest_pics/4-117.png"],
    ["踏切では、エンストを防止するため発進した時の低速ギアのまま一気に通過する。", "o", "本文の通り", ""],
    ["車の速度と燃料の消費量は密接な関係があり、速度が速過ぎても遅過ぎても燃料消費量は多くなり、急発進、急ブレーキ、空ふかしを行うと余分な燃料を消費する。", "o", "本文の通り", ""],
    ["車の総重量が750kgを超える車をけん引している車で、けん引するための構造と装置のあるものが、車両通行帯の設けられた自動車専用道路（標識や標示で指定されている場合）を通行する時は、最も左側の車両通行帯を通行しなければならない。", "o", "本文の通り", ""],
    ["パーキングチケット発給機から発給を受けたパーキングチケットは、車から離れている間は、携帯するのがよい。", "x", "本文の通り", ""],
    ["この二つの標識は、車両の横断禁止と転回禁止であり、後退は禁止されていない。", "o", "本文の通り", "/static/quest_pics/4-122.png"],
    ["車が60km/hでコンクリートの壁に激突した場合は、約14m（ビルの5階程度）から落ちた場合と同じ程度の衝撃力である。", "o", "本文の通り", ""],
    ["左折する時の合図の時期は、左折しようとする地点（交差点で左折する時は、その交差点）から3秒前である。", "x", "本文の通り", ""],
    ["交通事故を起こした時は、交通事故の状況を残しておくことが大切なので、他の交通の妨げになったとしても警察官が現場に到着するまでは、車を移動してはならない。", "x", "本文の通り", ""],
    ["この標示は、「停止禁止部分」を表している。", "x", "本文の通り", "/static/quest_pics/4-128.png"],
    ["高速道路で走行するとタイヤが過熱するので、タイヤの空気圧はやや低めにしておくとよい。", "x", "本文の通り", ""],
    ["総排気量660cc以下の普通貨物自動車の積荷の高さは、地上から3.8mまで荷物を積むことができる。", "x", "本文の通り", ""],
    ["赤信号の交差点で工事現場のガードマンが進むように合図したので進行した。", "x", "本文の通り", ""],
    ["狭い坂道で行き違いができない時は、上り坂での発進が難しいので、下り坂の車が道を譲る。", "o", "本文の通り", ""],
    ["前車を追い越そうとしたところ、前車が突然進路を変えようとして来たので、危険を避けるためやむを得ず、警音器を鳴らした。", "o", "本文の通り", ""],
    ["この標示は、前方に横断歩道または自転車横断帯があることをあらかじめ示している。", "o", "本文の通り", "/static/quest_pics/4-134.png"],
    ["最高速度50km/hと指定されている片側三車線の道路で、総排気量400ccを超える二輪車が通行する場合でも最高速度50km/hを超えて走行してはならない。", "o", "本文の通り", ""],
    ["長距離運転する時は、あらかじめ運転計画を立ててしまうと計画にとらわれがちになるので、計画は立てずにその場に応じて運転するとよい。", "x", "本文の通り", ""],
    ["普通自動車は右左折する場合や工事等でやむを得ない場合を除いて、この標識のある車両通行帯を通行してはならない。", "x", "本文の通り", "/static/quest_pics/4-137.png"],
    ["二輪車で走行中にエンジンの回転が上がった後、故障などにより下がらなくなった時は、点火スイッチを切ってエンジンの回転を止めることが大切である。", "o", "本文の通り", ""],
    ["児童などが乗り降りするために止まっている通学通園バスのそばを通る時は、徐行して安全を確かめなければならない。", "o", "本文の通り", ""],
    ["この標識は、「歩行者の横断禁止」を表している。", "x", "本文の通り", "/static/quest_pics/4-140.png"],
    ["追い越しをする時は、右側を通行しなければならないが、前車が右折のため道路の中央によって通行している場合（一方通行の場合は右側）は、後車は前車の左側を通行しなければならない。", "o", "本文の通り", ""],
    ["車を運転中、大地震が発生した場合は、急ハンドル、急ブレーキを使い、できるだけ早く道路の左側に停止させることが必要である。", "x", "本文の通り", ""],
    ["この標識のある交差点では、大型自動車を除く他の車は、直進してはならない。", "x", "本文の通り", "/static/quest_pics/4-143.png"],
    ["高速道路の本線車道を走行中、減速しなければならない場合は、一段低いギアに落としエンジンブレーキを使うとともにフットブレーキを数回に分けて使うのがよい。", "o", "本文の通り", ""],
    ["後輪が左に横すべりをはじめた時は、ブレーキを使わずアクセルをゆるめて同時にハンドルを右に切るとよい。", "x", "本文の通り", ""],
    ["この二つの標識の意味は、それぞれ同じである。", "o", "本文の通り", "/static/quest_pics/4-146.png"],
    ["横断歩道、自転車横断帯とその端から前後10m以内の場所は、駐車も停車もしてはならない。", "x", "本文の通り", ""],
    ["二輪車でカーブを曲がる時は、ハンドルを切るのではなく車体を傾ける事によって自然に曲がるような要領で行うのがよい。", "o", "本文の通り", ""],
    ["この標識のある区間内で見通しのきかない交差点、曲がり角、上り坂の頂上を通る時には、警音器を鳴らさなければならない。", "o", "本文の通り", "/static/quest_pics/4-149.png"],
    ["信号機の設置されている踏切で信号機の表示する青信号に従って通過する時は、安全を確認すれば一時停止の必要はない。", "o", "本文の通り", ""],
    ["交差点で左折しようとする時は、あらかじめその手前から道路の左端に寄り、交差点の側端に沿って進行すれば徐行しなくてもよい。", "x", "本文の通り", ""],
    ["この標示の路側帯では、駐車や停車はできないが走行することはできる。", "x", "本文の通り", "/static/quest_pics/4-152.png"],
    ["交通整理の行われていない横断歩道の手前30mは、原動機付自転車や自動車を追い越してはならないが、追い抜きはしてもよい。", "x", "本文の通り", ""],
    ["履物は運転操作には関係ないので、車を運転する前に注意をはらう必要はない。", "x", "本文の通り", ""],
    ["この標識のある所では、左右の見通しのきかない交差点においても徐行しなければならない。", "x", "本文の通り", "/static/quest_pics/4-155.png"],
    ["上り坂では、クラッチ操作で発進しようとする時、失敗して後退することがあるので四輪車の場合は、ハンドブレーキを使用するとよい。", "o", "本文の通り", ""],
    ["交通整理の行われていない交差点を右左折する時でも徐行しなければならない。", "o", "本文の通り", ""],
    ["この標識は「駐車禁止」を表している。", "x", "本文の通り", "/static/quest_pics/4-158.png"],
    ["道路に面した場所へ出入りするため、歩道や路側帯を横切る場合でも歩行者の通行を妨げる恐れがなければ、その直前で一時停止する必要はない。", "x", "本文の通り", ""],
    ["車は濡れたアスファルト路面を走る時などは、摩擦抵抗は小さくなり、制動距離が長くなる。", "o", "本文の通り", ""],
    ["この標識は「自転車横断帯」を表している。", "o", "本文の通り", "/static/quest_pics/4-161.png"],
    ["二輪車は、体で安定を保ちながら走り、停止すると安定を失うという構造上の特性をもっており、四輪車とは違った運転技術が必要である。", "o", "本文の通り", ""],
    ["中央分離帯のある高速自動車国道の本線車道では、大型乗用自動車、中型乗用自動車の法定最高速度は、時速80キロメートルである。", "x", "本文の通り", ""],
    ["この標識は「一方通行」の道路であることを表している。", "x", "本文の通り", "/static/quest_pics/4-164.png"],
    ["高速道路の本線車道とは、通常高速走行する部分をいうが、加速車線、減速車線も含まれる。", "x", "本文の通り", ""],
    ["タイヤの溝の深さが十分であるかどうかは、ウェア・インジケータで点検する。", "o", "本文の通り", ""],
    ["高速道路でやむを得ず駐停車する場合は、他の車の通行の妨げにならないように十分な幅のある路肩や路側帯に駐停車しなければならない。", "o", "本文の通り", ""],
    ["衝撃力は、速度と重量に応じて大きくなり、また、固い物にぶつかった時のように、衝撃の作用が短時間に行われる程、その力は大きくなる。", "o", "本文の通り", ""],
    ["高速自動車国道の本線車道が、道路の構造上往復の方向別に分離されていない区間での最高速度は一般道路と同じである。", "o", "本文の通り", ""],
    ["この標識のあるところでは、沿道に車庫を持つ車などで特に通行が認められた車しか通行してはならない。", "x", "本文の通り", "/static/quest_pics/4-170.png"],
    ["原動機付自転車は二つの車両通行帯がある信号機などにより交通整理の行われている交差点では、二段階の方法により右折をしなければならない。", "x", "本文の通り", ""],
    ["二輪車は機動性に富んでおり、交通渋滞の時は車の間をぬって走ったり、路側帯を走れるという利点がある。", "x", "本文の通り", ""],
    ["この標識は「駐車可」を表している。", "x", "本文の通り", "/static/quest_pics/4-173.png"],
    ["大型二輪免許を受けている者は、ミニカーを運転することができる。", "x", "本文の通り", ""],
    ["進路の前方に障害物がある所では、あらかじめ一時停止か減速して反対方向からの車に道を譲るのがよい。", "o", "本文の通り", ""],
    ["一方通行の道路では、道路の中央から右にはみ出して通行することができる。", "o", "本文の通り", ""],
    ["上り坂の頂上付近は、見通しが悪いので徐行しなければならない。", "o", "本文の通り", ""],
    ["この標示のある交差点で右折する時は、矢印の部分を通行しなければならない。", "o", "本文の通り", "/static/quest_pics/4-178.png"],
    ["標識などによって駐車が禁止されていない道路であっても、車の右側の道路上に3.5m以上の余地がなければ駐車はできない。", "o", "本文の通り", ""],
    ["ハイドロ・プレーニング現象とは、長い下り坂でフットブレーキを頻繁に使い過ぎた時に急にブレーキがきかなくなることをいう。", "x", "本文の通り", ""],
    ["この標識のあるところで軌道敷内を通行する車は、後方から路面電車が近づいてきても軌道敷外に出ることはない。", "x", "本文の通り", "/static/quest_pics/4-181.png"],
    ["故障車をロープやクレーンでけん引する時は、けん引免許はなくてもよい。", "o", "本文の通り", ""],
    ["運転免許は第一種運転免許、第二種運転免許及び、仮運転免許の三種に区分される。", "o", "本文の通り", ""],
    ["緊急自動車を運転する時は、その自動車の運転に必要な運転免許の他に、運転経験年数や年齢について特別の資格が必要である。", "o", "本文の通り", ""],
    ["車両通行帯のあるトンネルの中では、追い越しをすることができる。", "o", "本文の通り", ""],
    ["この標識のある交差点を右折する原動機付自転車は、あらかじめできるだけ道路の中央に寄り交差点の中心のすぐ内側を徐行しながら通行しなければならない。", "o", "本文の通り", "/static/quest_pics/4-186.png"],
    ["二輪車でブレーキをかける時は、車体を垂直に保ちハンドルを切らない状態でエンジンブレーキをきかせながら前後輪のブレーキを同時にかけるとよい。", "o", "本文の通り", ""],
    ["他の車両を追い越す時は、たとえ瞬間的であっても指定された最高速度を超えて運転してはならない。", "o", "本文の通り", ""],
    ["車を運転する時は、絶えず前方に注意するとともに、ミラーなどにより周囲の交通の状況に目を配ることが大切であり、一点だけを注視した運転は避けなければならない。", "o", "本文の通り", ""],
    ["二輪車がマフラーを取り外したり、切断したり、マフラーの芯を抜いたりすると騒音が大きくなるので、このような改造はしてはならない。", "o", "本文の通り", ""]
]
    # Titleモデルに「チャレンジ１」を保存（タイトルが既に存在する場合は取得）
    title, created = Title.objects.get_or_create(name=title_name)

    # 質問データを保存
    for question_text, answer, descriptions,path in question_list:
        Questions.objects.create(title=title, questions=question_text, answers=answer,descriptions=descriptions,images_path = path)

    return render(request, 'main_base.html')

